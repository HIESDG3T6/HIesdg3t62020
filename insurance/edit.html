
<!--Insurance Agent UI Assume agent logged in already-->
<!DOCTYPE html>
<html lang="en">
<head>
<title>Insurance Agent Panel </title>

	
	<!-- css files -->
	<link href="../css/css_slider.css" type="text/css" rel="stylesheet" media="all"><!-- slider css -->
    <link href="../css/bootstrap.css" rel='stylesheet' type='text/css' /><!-- bootstrap css -->
    <link href="../css/style.css" rel='stylesheet' type='text/css' /><!-- custom css -->
    
	<!-- //css files -->

	<!-- jquery-->
	<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	<!-- <script src="js/jquery.min.js"></script> -->
	<!-- //jquery-->

	<!-- google fonts -->
	<link href="//fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i,800,800i&amp;subset=cyrillic,cyrillic-ext,greek,greek-ext,latin-ext,vietnamese" rel="stylesheet">
	<link href="//fonts.googleapis.com/css?family=Dosis:200,300,400,500,600,700,800&amp;subset=latin-ext" rel="stylesheet">
	<!-- //google fonts -->
	
</head>
<body>

<!-- top header -->
<div class="header-top">
	<div class="container">
		<div class="row">
			<div class="col-sm-6">
				<ul class="d-lg-flex header-w3_pvt">
					<li class="mr-lg-3">
						<p> Welcome! Agent Wong</p>
						
					</li>

				</ul>
			</div>
			<div class="col-sm-6 header-right-w3_pvt">
				<ul class="d-lg-flex header-w3_pvt justify-content-lg-end">
					<li class="">
						<span class=""><span class="fa fa-clock-o"></span>Log out</span>
					</li>
				</ul>
			</div>
		</div>
	</div>
</div>
<!-- //top header -->

<!-- //header -->
<header class="py-3">
	<div class="container">
			<div id="logo">
				<h1> <a href="home.html"><span class="fa fa-stethoscope" aria-hidden="true"></span> Health Insurance </a></h1>
			</div>
		<!-- nav -->
		<nav class="d-lg-flex">

			<label for="drop" class="toggle"><span class="fa fa-bars"></span></label>
			<input type="checkbox" id="drop" />
			<ul class="menu mt-2 ml-auto">
				<li class="active"><a href="home.html">Home</a></li>
				<li class=""><a href="home.html">Account</a></li>

			</ul>
			<div class="login-icon ml-2">
				<a class="user" href="claim_history.html">Claims History</a>
			</div>
		</nav>
		<div class="clear"></div>
		<!-- //nav -->
	</div>
</header>
<!-- //header -->

<script>
	function test(Names){
	var status = ['Pending','Approved','Rejected']
	var Name;
	for (var i of status ){    
		var tempname="mune_x"+i                                                                            
		var NewsHot=i    //  x is part of id name for display
		if (Names==tempname){
			Nnews=document.getElementById(NewsHot)
			Nnews.style.display='';
		}else{
			Nnews=document.getElementById(NewsHot)
			Nnews.style.display='none';   
		}
	}
}
</script>


<!--tables for claims --> 
<section class="table" id="claims">
	<div class="table-layer py-5">
		<div class="container py-lg-5">
			<h3 class="heading text-center mb-sm-5 mb-4">Claim</h3>
			<div class="table-block p-4">
				<!-- A form to update-->
				<form action="#" id ="claimform"method="post" >
					<div class="row" >
						
						
						<div class="col-md-6 wthree_contact_left">
							<div class="form-group">
								<p class="col-sm-6 header-right-w3_pvt" style="color:white;" >Claim ID</p>
								<input type="text" id = "ClaimID_text" name="ClaimID" class="form-control" placeholder="Claim ID" required="" disabled>
							</div>

							<div class="form-group">
								<p class="col-sm-6 header-right-w3_pvt" style="color:white;" >Clinic Name</p>
								<input type="text" id = "ClinicName_text" name="ClinicName" class="form-control" placeholder="Clinic ID" required="" disabled>
							</div>
							<div class="form-group">
								<p class="col-sm-6 header-right-w3_pvt" style="color:white;" >Bill Amount</p>
								<input type="text" id = "BillAmount_text" name="BillAmount" class="form-control" placeholder="Bill Amount" required=""disabled>
							</div>
							<div class="form-group">
								<p class="col-sm-6 header-right-w3_pvt" style="color:white;" >Claim Status</p>
								<input type="text" id = "ClaimStatus_text" name="ClaimStatus" class="form-control" placeholder="Claim Status" required="" disabled>
							</div>
                            
						</div>
						<div class="col-md-6 wthree_contact_left_grid">
							<div class="form-group">
								<p class="col-sm-6 header-right-w3_pvt" style="color:white;" >Claim Date</p>
								<input type="text" id = "ClaimDate_text" name="ClaimDate" class="form-control" placeholder="Claim Date" required="" disabled>
                            </div>

							
							<div class="form-group">
								<p class="col-sm-6 header-right-w3_pvt" style="color:white;" >Patient ID</p>
								<input type="text" id = "PatientID_text" name="PatientID" class="form-control" placeholder="Patient ID" required="" disabled>
							</div>
							<div class="form-group">
								<p class="col-sm-6 header-right-w3_pvt" style="color:white;" >Claim Amount</p>
								<input type="text" id = "ClaimedAmount_text" name="ClaimedAmount" class="form-control" placeholder="Claim Amount" required="" disabled>
							</div>
                            
                            
							<div class="form-group">
								<p class="col-sm-6 header-right-w3_pvt" style="color:white;" >Refund Status</p>
								<select onChange="javascript:test('mune_x'+this.value)" id="RefundStatus_text" name="RefundStatus" class="form-control" placeholder="Refund Status">
									<option value='Pending' name="1">Pending</option>
									<option value='Approved' name="2">Approved</option>
									<option value='Rejected' name="3">Rejected</option>
								</select>

							</div>
						</div>
						<div class="col-md-12">
          
							<p class="col-sm-6 header-right-w3_pvt" style="color:white;" >Prescription</p>
							<textarea name="message" id = "Medication_text" name="Medication" class="form-control" placeholder="Medication" required=""disabled></textarea>

						</div>

						<!-------------------------------------- Customerize the Submit Button for different status ------------------------------------>
						<!-- for pending the claim -->
						<div class="col-md-12 grid p" id='Pending'>
							<p class="col-sm-6 header-right-w3_pvt" >   </p>
							<div class="submit-buttons" style="text-align: center;">
								<!-- show nothing for button-->
                            </div>
						</div>

						<!-- for approve the claim -->
						<div class="col-md-12 grid p" id='Approved' style="display:none">
							<p class="col-sm-6 header-right-w3_pvt" >   </p>
							<div class="submit-buttons" style="text-align: center;">
								<button type="submit" class="btn" id='pay_button' > Pay  Patient  for  Claim </button>
								<!-- onclick="payment_paypal()" -->
                            </div>
						</div>

						<!-- for reject the claim -->
						<div class="col-md-12 grid p" id='Rejected' style="display:none">
							<p class="col-sm-6 header-right-w3_pvt" >   </p>
							<div class="submit-buttons" style="text-align: center;">
								<button type="submit" class="btn" id='reject_button'>Update Claim Status</button>
                            </div>
						</div>
						<!-------------------------------------------- END of button ------------------------------------------------>

						<div class="login-icon ml-2">
							<a class="user" href="home.html">Back</a>
						</div>



					</div>
                </form>
			</div>			
		</div>	
	</div>

</section>

<!-- //tables for claims --> 



<!-- copyright -->
<div class="copyright">
	<div class="container py-4">
		<div class=" text-center">
			<p>© 2020 Health Insurance Inc. All Rights Reserved </a> </p>
		</div>
	</div>
</div>
<!-- //copyright -->
		
<!-- move top -->
<div class="move-top text-right">
	<a href="#home" class="move-top"> 
		<span class="fa fa-angle-up  mb-3" aria-hidden="true"></span>
	</a>
</div>
<!-- move top -->


	<!-- START TO DISPLAY MESSAGE FROM DATABASE-->
	<script>
		// Helper function to display error message
		function showError(message) {
            // Hide the table and button in the event of error
           
            // Display an error under the main container
            $('#main-container')
                .append("<label>"+message+"</label>");
        }



		// get the ClaimID from the url query e.g. ?ClaimID = 5
		function getvalue(name){
			var reg = new RegExp("(^|&)"+name+"=([^&]*)(&|$)");
			var r = window.location.search.substr(1).match(reg);
			if (r!=null) return r[2]; return '';
		}



		var ClaimID = getvalue('ClaimID');
		//alert(getvalue('ClaimID'));


		// anonymous async function 
        // - using await requires the function that calls it to be async
		$(async() => {       
            // Change serviceURL to your own
            var serviceURL = "http://127.0.0.1:5000/claims/"+ClaimID;

			// console.log(serviceURL);
			//after that can change it to only display opening 
            try {
                const response =
                 await fetch(
                   serviceURL, { method: 'GET' }
                );
                const data = await response.json();
                
				// console.log(data)


				//set the value to the textinput
				$("#ClaimID_text").val(ClaimID);
				$("#ClinicName_text").val(data.ClinicName);
				$("#BillAmount_text").val(data.BillAmount);
				$("#ClaimStatus_text").val(data.ClaimStatus);
				$("#ClaimDate_text").val(data.ClaimDate);
				$("#PatientID_text").val(data.PatientID);
				$("#ClaimedAmount_text").val(data.ClaimedAmount);
				$("#RefundStatus_text").val(data.RefundStatus);
				$("#Medication_text").val(data.Medicine);

            
            } catch (error) {
                // Errors when calling the service; such as network error, 
                // service offline, etc
                showError('There is a problem retrieving insurance claims data, please try again later.<br />'+error);
            } // error
        });



		// =========================================================================
		//POST METHODS when click the submit button => call insurance_claim MS for updating <status> NO MATTER APPROVE OR REJECT
		async function postData(serviceURL, requestBody){

			var requestParam = {
				headers: {"content-type": "application/json" },
				mode: 'cors', // other options: no-cors, etc.
			        method: 'POST',
			        body: JSON.stringify(requestBody)
			}

			try{
				const response = await fetch(serviceURL, requestParam);
			    data = await response.json();
			//     console.log("update status data is "+data);
				
				if( response.ok){
					// window.location.replace("home.html");
				}

			}catch(error){
				console.error(error);
				showError(error);
			}
		}

		$("#claimform").submit(function(){
            event.preventDefault();
            

			var ClaimID = $('#ClaimID_text').val();
			var ClinicName = $('#ClinicName_text').val();
			var BillAmount = $('#BillAmount_text').val();
			var ClaimStatus = $('#ClaimStatus_text').val();
			var ClaimDate = $('#ClaimDate_text').val();
			var PatientID = $('#PatientID_text').val();
			var ClaimedAmount = $('#ClaimedAmount_text').val();
			var RefundStatus = $('#RefundStatus_text').val();
			var Medicine = $('#Medication_text').val();

            var serviceURL = "http://127.0.0.1:5000/claims/" +ClaimID + "/";
            var requestBody = {
				// ClaimID:ClaimID,
				ClinicName:ClinicName,
				BillAmount:BillAmount,
				ClaimStatus:ClaimStatus,
				ClaimDate:ClaimDate,
				PatientID:PatientID,
				ClaimedAmount:ClaimedAmount,
				RefundStatus:RefundStatus,
				Medicine:Medicine
            };
			
			postData(serviceURL,requestBody);
			
       });


	   // ======================================================================
	   // GET METHOD to retrieve approval url for payment only when pay button is click
	   function showError(message) {
            // Hide the table and button in the event of error
            $('#claimsTable').hide(); 
            // Display an error under the main container
            $('#main-container')
                .append("<label>"+message+"</label>");
        }

		// anonymous async function 
        // - using await requires the function that calls it to be async
		$(function(){
			console.log("1");
			$('#pay_button').click(async(event) => {       
				// Change serviceURL to your own
				console.log("2");
				var serviceURL = "http://127.0.0.1:5001/refund/"+ClaimID;
				console.log("ClaimID is "+ClaimID);
				//after that can change it to only display opening 
				try {
					const response =
					await fetch(
					serviceURL, { method: 'GET' }
					);
					const data = await response.json();
					console.log("refund data is"+data);
					var approval_url = data.Approval_url; 
					console.log("3: "+approval_url);
					// array or array.length are falsy
					if (!approval_url) {
						console.log("4");
						showError('data is empty or undefined')
					} else {
						console.log("5");
						window.location.replace(approval_url)
					}
				} catch (error) {
					// Errors when calling the service; such as network error, 
					// service offline, etc
					showError('There is a problem when processing a payment, please try again later.<br />'+error);
				} // error
        	});
		});
		


	</script>

	<!--// END TO DISPLAY MESSAGE FROM DATABASE -->

</body>
</html>

